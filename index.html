<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹ç¼©æœºæ•ˆç‡è®¡ç®—å™¨ v2.7 (CoolProp)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .input-group {
            margin-bottom: 0.75rem; /* 12px */
        }
        input[type="radio"] {
            margin-top: -0.1rem;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* v2.6 æ–°å¢: å¤‡æ³¨æç¤ºæ¡† (Tooltip) æ ·å¼ */
        .tooltip {
            position: relative;
            cursor: help;
            display: inline-block;
            margin-left: 4px;
            color: #4A90E2; /* blue-500 */
            border-bottom: 1px dotted #4A90E2;
            font-weight: bold;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 260px;
            background-color: #262626; /* neutral-800 */
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above the text */
            left: 50%;
            margin-left: -130px; /* Center it */
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-family: sans-serif; /* Not mono */
            font-weight: normal;
            line-height: 1.4;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* v2.6 æ–°å¢: A4 æ‰“å°æ ·å¼ */
        @media print {
            /* éšè—æ‰€æœ‰éæ‰“å°å†…å®¹ */
            body > *:not(#print-container) {
                display: none !important;
            }
            
            /* æ‰“å°å®¹å™¨è®¾ç½® */
            #print-container {
                display: block !important;
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
            }

            /* é¡µé¢è®¾ç½® */
            @page {
                size: A4;
                margin: 1.5cm;
            }

            body {
                background-color: #fff;
                color: #000;
                font-size: 10pt;
                font-family: 'Times New Roman', serif;
            }

            h1, h2, h3 {
                color: #000 !important;
                border-bottom: 2px solid #000;
                padding-bottom: 4px;
                margin-top: 1.5rem;
                page-break-after: avoid;
            }
            h1 { font-size: 18pt; margin-bottom: 1rem; }
            h2 { font-size: 14pt; margin-bottom: 0.5rem; }
            h3 { font-size: 12pt; }

            /* æ‰“å°è¡¨æ ¼æ ·å¼ */
            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
                font-size: 10pt;
            }
            .print-table th, .print-table td {
                border: 1px solid #000;
                padding: 6px 8px;
                text-align: left;
            }
            .print-table th {
                background-color: #f0f0f0;
                font-weight: bold;
                width: 40%;
            }
            .print-table td {
                width: 60%;
            }

            /* æ‰“å°ç»“æœ pre æ ·å¼ */
            pre.print-results {
                white-space: pre-wrap;
                word-wrap: break-word;
                font-family: 'Courier New', monospace;
                font-size: 9.5pt;
                background-color: #f9f9f9;
                border: 1px solid #ccc;
                padding: 10px;
                margin-top: 10px;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="container mx-auto p-4 sm:p-8 max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">å‹ç¼©æœºæ€§èƒ½è®¡ç®—å™¨ v2.7</h1>

        <div class="mb-4 bg-white p-4 rounded-lg shadow-md">
            <label class="text-xl font-semibold text-gray-800">é€‰æ‹©è®¡ç®—æ¨¡å¼:</label>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-6 mt-2">
                <label class="inline-flex items-center">
                    <input type="radio" name="main_mode" id="mode-1-radio" value="eval" class="form-radio h-5 w-5 text-blue-600" checked>
                    <span class="ml-2 text-lg">æ¨¡å¼ä¸€: æ€§èƒ½è¯„ä¼° (è¾“å…¥åŠŸç‡/å®¹é‡, è®¡ç®—æ•ˆç‡)</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="main_mode" id="mode-2-radio" value="predict" class="form-radio h-5 w-5 text-blue-600">
                    <span class="ml-2 text-lg">æ¨¡å¼äºŒ: æ€§èƒ½é¢„æµ‹ (è¾“å…¥æ•ˆç‡, è®¡ç®—åŠŸç‡/å®¹é‡)</span>
                </label>
            </div>
        </div>

        <div id="mode-1-container">
            <div class="bg-white shadow-xl rounded-lg p-6 sm:p-8">
                
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">æ¨¡å¼ä¸€: æ€§èƒ½è¯„ä¼°</h2>

                <form id="calc-form-mode-1">
                    <h2 class="text-2xl font-semibold text-blue-700 mb-4 border-b pb-2">1. è¾“å…¥å‚æ•°</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                        <div>
                            <fieldset class="border p-4 rounded-lg mb-4">
                                <legend class="font-medium px-2">å·¥è´¨ä¸å‹ç¼©æœº</legend>
                                
                                <div class="input-group">
                                    <label for="fluid" class="block text-sm font-medium text-gray-700 mb-1">åˆ¶å†·å‰‚</label>
                                    <select id="fluid" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-white" required>
                                        <option value="R134a">R134a</option>
                                        <option value="R245fa" selected>R245fa</option>
                                        <option value="R1233zd(E)">R1233zd(E)</option>
                                        <option value="R1234ze(E)">R1234ze(E)</option>
                                        <option value="R123">R123</option>
                                        <option value="R22">R22</option>
                                        <option value="R410A">R410A</option>
                                        <option value="R32">R32</option>
                                        <option value="R290">R290</option>
                                        <option value="R717">R717 (Ammonia)</option>
                                        <option value="R515B">R515B</option>
                                        <option value="R142b">R142b</option>
                                        <option value="R1336mzz(Z)">R1336mzz(Z)</option>
                                        <option value="R744">R744 (CO2)</option>
                                        <option value="R600a">R600a (Isobutane)</option>
                                        <option value="R152a">R152a</option>
                                        <option value="R454B">R454B</option>
                                        <option value="R513A">R513A</option>
                                    </select>
                                </div>

                                <pre id="fluid-info" class="text-xs text-gray-600 bg-gray-50 p-3 rounded-md border border-gray-200 mb-3 font-mono">
--- æ­£åœ¨åŠ è½½ç‰©æ€§åº“ ---
                                </pre>
                                
                                <div class="input-group">
                                    <label for="rpm" class="block text-sm font-medium text-gray-700 mb-1">å‹ç¼©æœºè½¬é€Ÿ (RPM)</label>
                                    <input type="number" id="rpm" value="2900" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                </div>

                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ç†è®ºè¾“æ°”é‡æ¨¡å¼</label>
                                    <div class="flex space-x-4">
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="flow_mode" id="flow_mode_rpm_m1" value="rpm" class="form-radio" checked>
                                            <span class="ml-2">æŒ‰è½¬é€Ÿä¸æ’é‡</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="flow_mode" id="flow_mode_vol_m1" value="vol" class="form-radio">
                                            <span class="ml-2">æŒ‰ä½“ç§¯æµé‡</span>
                                        </label>
                                    </div>
                                </div>

                                <div id="rpm-inputs">
                                    <div class="input-group">
                                        <label for="displacement" class="block text-sm font-medium text-gray-700 mb-1">æ¯è½¬æ’é‡ (cmÂ³/rev)</label>
                                        <input type="number" id="displacement" value="437.5" step="any" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                    </div>
                                </div>

                                <div id="vol-inputs" style="display: none;">
                                    <div class="input-group">
                                        <label for="flow_m3h" class="block text-sm font-medium text-gray-700 mb-1">ç†è®ºä½“ç§¯æµé‡ (mÂ³/h)</label>
                                        <input type="number" id="flow_m3h" value="100" step="any" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset class="border p-4 rounded-lg mb-4">
                                <legend class="font-medium px-2">åŠŸç‡ä¸å®¹é‡</legend>

                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å®¹é‡æ¨¡å¼</label>
                                    <div class="flex space-x-4">
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="capacity_mode" value="refrigeration" class="form-radio">
                                            <span class="ml-2">åˆ¶å†·é‡</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="capacity_mode" value="heating" class="form-radio" checked>
                                            <span class="ml-2">åˆ¶çƒ­é‡ (å†·å‡å™¨)</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="input-group">
                                    <label for="capacity" id="capacity-label" class="block text-sm font-medium text-gray-700 mb-1">åˆ¶çƒ­é‡ (kW)</label>
                                    <input type="number" id="capacity" value="44.9" step="any" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                                
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">åŠŸç‡æ¨¡å¼</label>
                                    <div class="flex space-x-4">
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="power_mode" id="power_mode_shaft" value="shaft" class="form-radio">
                                            <span class="ml-2">è½´åŠŸç‡</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="power_mode" id="power_mode_input" value="input" class="form-radio" checked>
                                            <span class="ml-2">è¾“å…¥åŠŸç‡ (ç”µæœº)</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="input-group">
                                    <label for="power" id="power-label" class="block text-sm font-medium text-gray-700 mb-1">è¾“å…¥åŠŸç‡ (kW) (ç”µæœº)</label>
                                    <input type="number" id="power" value="19.4" step="any" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                </div>

                                <div id="motor-eff-group" class="input-group" style="display: block;"> <label for="motor_eff" class="block text-sm font-medium text-gray-700 mb-1">ç”µæœºæ•ˆç‡</label>
                                    <input type="number" id="motor_eff" value="0.95" step="0.01" min="0.5" max="1.0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                </div>

                            </fieldset>
                        </div>

                        <div>
                            <fieldset class="border p-4 rounded-lg mb-4">
                                <legend class="font-medium px-2">çƒ­åŠ›å­¦å·¥å†µ</legend>
                                <div class="input-group">
                                    <label for="temp_evap" class="block text-sm font-medium text-gray-700 mb-1">è’¸å‘æ¸©åº¦ (Â°C)</label>
                                    <input type="number" id="temp_evap" value="50" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                                
                                <div class="input-group">
                                    <label for="temp_cond" class="block text-sm font-medium text-gray-700 mb-1">å†·å‡æ¸©åº¦ (Â°C)</label>
                                    <input type="number" id="temp_cond" value="125" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                                
                                <div class="input-group">
                                    <label for="superheat" class="block text-sm font-medium text-gray-700 mb-1">
                                        æœ‰æ•ˆè¿‡çƒ­åº¦ (K)
                                        <span class="tooltip">(?)
                                            <span class="tooltiptext">æŒ‡å‹ç¼©æœºå¸æ°”å£æ¸©åº¦é«˜å‡ºè’¸å‘é¥±å’Œæ¸©åº¦çš„åº¦æ•°ã€‚è¿™æ˜¯è®¡ç®—å¸æ°”ç‚¹(çŠ¶æ€1)çš„å…³é”®å‚æ•°ã€‚</span>
                                        </span>
                                    </label>
                                    <input type="number" id="superheat" value="5" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                </div>

                                <div class="input-group">
                                    <label for="subcooling" class="block text-sm font-medium text-gray-700 mb-1">
                                        è¿‡å†·åº¦ (K)
                                        <span class="tooltip">(?)
                                            <span class="tooltiptext">æŒ‡å†·å‡å™¨å‡ºå£æ¶²ä½“æ¸©åº¦ä½äºå†·å‡é¥±å’Œæ¸©åº¦çš„åº¦æ•°ã€‚è¿™æ˜¯è®¡ç®—èŠ‚æµé˜€å‰(çŠ¶æ€3)çš„å…³é”®å‚æ•°ã€‚</span>
                                        </span>
                                    </label>
                                    <input type="number" id="subcooling" value="5" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                            </fieldset>
                        </div>
                    </div>

                    <div class="mt-4 text-center">
                        <button type="submit" id="calc-button-mode-1" class="w-full md:w-1/2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 ease-in-out" disabled>
                            æ­£åœ¨åŠ è½½ç‰©æ€§åº“...
                        </button>
                    </div>
                </form>

                <div class="mt-8">
                    <div>
                        <h2 class="text-2xl font-semibold text-blue-700 mb-4 border-b pb-2">2. è®¡ç®—ç»“æœ (æ¨¡å¼ä¸€)</h2>
                        <pre id="results-mode-1" class="bg-gray-50 text-gray-900 p-6 rounded-lg shadow-inner overflow-x-auto min-h-[400px] font-mono text-sm">
--- è¯·è¾“å…¥å‚æ•°å¹¶ç‚¹å‡»è®¡ç®— ---
--- ç¡®ä¿ coolprop.js å’Œ coolprop.wasm ä¸æ­¤ html æ–‡ä»¶åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸­ ---
--- å¹¶ä¸”, æ‚¨å¿…é¡»é€šè¿‡æœ¬åœ°æœåŠ¡å™¨ (å¦‚ VSCode "Go Live") è¿è¡Œæ­¤æ–‡ä»¶, å¦åˆ™ .wasm å¯èƒ½åŠ è½½å¤±è´¥ ---
                        </pre>
                        
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button type="button" id="print-button-mode-1" class="w-full bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 transition duration-300" disabled>
                                ğŸ–¨ï¸ æ‰“å°æŠ¥å‘Š (A4)
                            </button>
                            <button type="button" id="transfer-to-mode-2" class="w-full bg-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition duration-300 ease-in-out" disabled>
                                âœ å°†æ­¤å·¥å†µä»£å…¥æ¨¡å¼äºŒ (é¢„æµ‹)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="mode-2-container" style="display: none;">
            <div class="bg-white shadow-xl rounded-lg p-6 sm:p-8">

                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">æ¨¡å¼äºŒ: æ€§èƒ½é¢„æµ‹</h2>
                
                <form id="calc-form-mode-2">
                    <h2 class="text-2xl font-semibold text-green-700 mb-4 border-b pb-2">1. è¾“å…¥å‚æ•°</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                        <div>
                            <fieldset class="border p-4 rounded-lg mb-4">
                                <legend class="font-medium px-2">å·¥è´¨ä¸å‹ç¼©æœº</legend>
                                
                                <div class="input-group">
                                    <label for="fluid_m2" class="block text-sm font-medium text-gray-700 mb-1">åˆ¶å†·å‰‚</label>
                                    <select id="fluid_m2" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 bg-white" required>
                                        <option value="R134a">R134a</option>
                                        <option value="R245fa" selected>R245fa</option>
                                        <option value="R1233zd(E)">R1233zd(E)</option>
                                        <option value="R1234ze(E)">R1234ze(E)</option>
                                        <option value="R123">R123</option>
                                        <option value="R22">R22</option>
                                        <option value="R410A">R410A</option>
                                        <option value="R32">R32</option>
                                        <option value="R290">R290</option>
                                        <option value="R717">R717 (Ammonia)</option>
                                        <option value="R515B">R515B</option>
                                        <option value="R142b">R142b</option>
                                        <option value="R1336mzz(Z)">R1336mzz(Z)</option>
                                        <option value="R744">R744 (CO2)</option>
                                        <option value="R600a">R600a (Isobutane)</option>
                                        <option value="R152a">R152a</option>
                                        <option value="R454B">R454B</option>
                                        <option value="R513A">R513A</option>
                                    </select>
                                </div>

                                <pre id="fluid-info-m2" class="text-xs text-gray-600 bg-gray-50 p-3 rounded-md border border-gray-200 mb-3 font-mono">
--- æ­£åœ¨åŠ è½½ç‰©æ€§åº“ ---
                                </pre>
                                
                                <div class="input-group">
                                    <label for="rpm_m2" class="block text-sm font-medium text-gray-700 mb-1">å‹ç¼©æœºè½¬é€Ÿ (RPM)</label>
                                    <input type="number" id="rpm_m2" value="2900" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" required>
                                </div>

                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ç†è®ºè¾“æ°”é‡æ¨¡å¼</label>
                                    <div class="flex space-x-4">
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="flow_mode_m2" id="flow_mode_rpm_m2" value="rpm" class="form-radio" checked>
                                            <span class="ml-2">æŒ‰è½¬é€Ÿä¸æ’é‡</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="flow_mode_m2" id="flow_mode_vol_m2" value="vol" class="form-radio">
                                            <span class="ml-2">æŒ‰ä½“ç§¯æµé‡</span>
                                        </label>
                                    </div>
                                </div>

                                <div id="rpm-inputs-m2">
                                    <div class="input-group">
                                        <label for="displacement_m2" class="block text-sm font-medium text-gray-700 mb-1">æ¯è½¬æ’é‡ (cmÂ³/rev)</label>
                                        <input type="number" id="displacement_m2" value="437.5" step="any" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" required>
                                    </div>
                                </div>

                                <div id="vol-inputs-m2" style="display: none;">
                                    <div class="input-group">
                                        <label for="flow_m3h_m2" class="block text-sm font-medium text-gray-700 mb-1">ç†è®ºä½“ç§¯æµé‡ (mÂ³/h)</label>
                                        <input type="number" id="flow_m3h_m2" value="100" step="any" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500">
                                    </div>
                                </div>
                            </fieldset>
                        </div>

                        <div>
                            <fieldset class="border p-4 rounded-lg mb-4">
                                <legend class="font-medium px-2">çƒ­åŠ›å­¦å·¥å†µ</legend>
                                <div class="input-group">
                                    <label for="temp_evap_m2" class="block text-sm font-medium text-gray-700 mb-1">è’¸å‘æ¸©åº¦ (Â°C)</label>
                                    <input type="number" id="temp_evap_m2" value="50" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" required>
                                </div>
                                
                                <div class="input-group">
                                    <label for="temp_cond_m2" class="block text-sm font-medium text-gray-700 mb-1">å†·å‡æ¸©åº¦ (Â°C)</label>
                                    <input type="number" id="temp_cond_m2" value="125" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" required>
                                </div>
                                
                                <div class="input-group">
                                    <label for="superheat_m2" class="block text-sm font-medium text-gray-700 mb-1">æœ‰æ•ˆè¿‡çƒ­åº¦ (K)</label>
                                    <input type="number" id="superheat_m2" value="5" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" required>
                                </div>

                                <div class="input-group">
                                    <label for="subcooling_m2" class="block text-sm font-medium text-gray-700 mb-1">è¿‡å†·åº¦ (K)</label>
                                    <input type="number" id="subcooling_m2" value="5" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" required>
                                </div>
                            </fieldset>

                            <fieldset class="border p-4 rounded-lg mb-4">
                                <legend class="font-medium px-2">æ•ˆç‡å‚æ•°</legend>
                                
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æ•ˆç‡åŸºå‡†</label>
                                    <div class="flex space-x-4">
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="eff_mode_m2" id="eff_mode_shaft_m2" value="shaft" class="form-radio">
                                            <span class="ml-2">åŸºäºè½´åŠŸç‡ (Î·_s)</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="eff_mode_m2" id="eff_mode_input_m2" value="input" class="form-radio" checked>
                                            <span class="ml-2">åŸºäºè¾“å…¥åŠŸç‡ (Î·_total)</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="input-group">
                                    <label for="eta_s_m2" id="eta_s_label_m2" class="block text-sm font-medium text-gray-700 mb-1">
                                        æ€»ç­‰ç†µæ•ˆç‡ (Î·_total)
                                        <span class="tooltip">(?)
                                            <span class="tooltiptext" id="tooltip-eta-s-m2">åŸºäºã€è¾“å…¥åŠŸç‡ã€‘ã€‚Î·_total = ç†è®ºç­‰ç†µåŠŸç‡ / ç”µæœºè¾“å…¥åŠŸç‡ã€‚</span>
                                        </span>
                                    </label>
                                    <input type="number" id="eta_s_m2" value="0.581" step="any" min="0.1" max="1.5" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" required>
                                </div>
                                <div class="input-group">
                                    <label for="eta_v_m2" class="block text-sm font-medium text-gray-700 mb-1">
                                        å®¹ç§¯æ•ˆç‡ (Î·_v)
                                        <span class="tooltip">(?)
                                            <span class="tooltiptext">Î·_v = å®é™…å¸æ°”ä½“ç§¯æµé‡ / ç†è®ºè¾“æ°”é‡ã€‚åæ˜ äº†å‹ç¼©æœºå†…å®¹ç§¯æ³„æ¼å’Œä½™éš™å®¹ç§¯çš„å½±å“ã€‚</span>
                                        </span>
                                    </label>
                                    <input type="number" id="eta_v_m2" value="0.901" step="any" min="0.1" max="1.5" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" required>
                                </div>
                                <div id="motor-eff-group-m2" class="input-group" style="display: block;"> <label for="motor_eff_m2" class="block text-sm font-medium text-gray-700 mb-1">ç”µæœºæ•ˆç‡</label>
                                    <input type="number" id="motor_eff_m2" value="0.95" step="0.01" min="0.5" max="1.0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500">
                                </div>
                            </fieldset>

                        </div>
                    </div>

                    <div class="mt-4 text-center">
                        <button type="submit" id="calc-button-mode-2" class="w-full md:w-1/2 bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-300 ease-in-out" disabled>
                            æ­£åœ¨åŠ è½½ç‰©æ€§åº“...
                        </button>
                    </div>
                </form>

                <div class="mt-8">
                    <div>
                        <h2 class="text-2xl font-semibold text-green-700 mb-4 border-b pb-2">2. è®¡ç®—ç»“æœ (æ¨¡å¼äºŒ)</h2>
                        <pre id="results-mode-2" class="bg-gray-50 text-gray-900 p-6 rounded-lg shadow-inner overflow-x-auto min-h-[400px] font-mono text-sm">
--- è¯·è¾“å…¥å‚æ•°å¹¶ç‚¹å‡»è®¡ç®— ---
                        </pre>
                        <div class="mt-4 text-center">
                            <button type="button" id="print-button-mode-2" class="w-full md:w-1/2 bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 transition duration-300" disabled>
                                ğŸ–¨ï¸ æ‰“å°æŠ¥å‘Š (A4)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <footer class="text-center text-gray-600 text-sm mt-8 pb-4 max-w-4xl mx-auto px-4">
        <p><strong>ç‰ˆæœ¬:</strong> v2.7 (å¢åŠ æ’æ°”æ¸©åº¦ T2s / T2a è®¡ç®—)</p>
        <p><strong>ç¼–è€…:</strong> è†ç‚è£ (Jing Yanrong)</p>
        <blockquote class="mt-2 border-l-4 border-gray-300 pl-4 italic">
            ç¼–è€…å·²å°½åŠ›ç¡®ä¿æœ¬è®¡ç®—å™¨ç»“æœçš„å‡†ç¡®æ€§ï¼Œä½†ä¸å¯¹ä»»ä½•å› ä½¿ç”¨æœ¬å·¥å…·è€Œå¯¼è‡´çš„æ½œåœ¨é”™è¯¯æˆ–æŸå¤±æ‰¿æ‹…è´£ä»»ã€‚è®¡ç®—ç»“æœä»…ä¾›å‚è€ƒã€‚
        </blockquote>
    </footer>

    <script type="module">
        // 1. å¯¼å…¥ CoolProp æ¨¡å—
        import Module from './coolprop.js';

        let CP; // å…¨å±€å˜é‡ï¼Œç”¨äºæŒæœ‰ CoolProp å®ä¾‹
        let lastMode1Results = null; // ç”¨äºå­˜å‚¨æ¨¡å¼ä¸€çš„ç»“æœä»¥è¿›è¡Œè½¬æ¢
        
        // v2.6 æ–°å¢: å­˜å‚¨åŸå§‹æ–‡æœ¬ç”¨äºæ‰“å°
        let lastMode1ResultText = null;
        let lastMode2ResultText = null;

        // v2.6 æ›´æ–°: å¢åŠ  8 ç§æ–°å·¥è´¨
        const fluidInfoData = {
            'R134a':        { gwp: 1430, odp: 0,    safety: 'A1' },
            'R245fa':       { gwp: 1030, odp: 0,    safety: 'B1' },
            'R1233zd(E)':   { gwp: 7,    odp: 0,    safety: 'A1' },
            'R1234ze(E)':   { gwp: 1,    odp: 0,    safety: 'A2L' },
            'R123':         { gwp: 77,   odp: 0.02, safety: 'B1' },
            'R22':          { gwp: 1810, odp: 0.055,safety: 'A1' },
            'R410A':        { gwp: 2088, odp: 0,    safety: 'A1' },
            'R32':          { gwp: 675,  odp: 0,    safety: 'A2L' },
            'R290':         { gwp: 3,    odp: 0,    safety: 'A3' },
            'R717':         { gwp: 0,    odp: 0,    safety: 'B2L' },
            // --- v2.6 æ–°å¢å·¥è´¨ ---
            'R515B':        { gwp: 299,  odp: 0,    safety: 'A1' },
            'R142b':        { gwp: 1980, odp: 0.057,safety: 'A2' },
            'R1336mzz(Z)':  { gwp: 7,    odp: 0,    safety: 'A1' },
            'R744':         { gwp: 1,    odp: 0,    safety: 'A1' },
            'R600a':        { gwp: 3,    odp: 0,    safety: 'A3' }, // Isobutane
            'R152a':        { gwp: 138,  odp: 0,    safety: 'A2' },
            'R454B':        { gwp: 466,  odp: 0,    safety: 'A2L' },
            'R513A':        { gwp: 631,  odp: 0,    safety: 'A1' }
        };

        // --- DOM å…ƒç´ å¼•ç”¨ (é€šç”¨) ---
        const mode1Container = document.getElementById('mode-1-container');
        const mode2Container = document.getElementById('mode-2-container');
        const mode1Radio = document.getElementById('mode-1-radio');
        const mode2Radio = document.getElementById('mode-2-radio');

        // --- DOM å…ƒç´ å¼•ç”¨ (æ¨¡å¼ä¸€) ---
        const calcButtonM1 = document.getElementById('calc-button-mode-1');
        const resultsDivM1 = document.getElementById('results-mode-1');
        const calcFormM1 = document.getElementById('calc-form-mode-1');
        const transferButton = document.getElementById('transfer-to-mode-2');
        const printButtonM1 = document.getElementById('print-button-mode-1'); // v2.6 æ–°å¢
        
        const fluidSelectM1 = document.getElementById('fluid');
        const fluidInfoDivM1 = document.getElementById('fluid-info');

        const flowModeRadiosM1 = document.querySelectorAll('input[name="flow_mode"]');
        const flowModeRpmM1 = document.getElementById('flow_mode_rpm_m1');
        const flowModeVolM1 = document.getElementById('flow_mode_vol_m1');
        const rpmInputsM1 = document.getElementById('rpm-inputs');
        const volInputsM1 = document.getElementById('vol-inputs');
        const flowM3hInputM1 = document.getElementById('flow_m3h');
        const displacementInputM1 = document.getElementById('displacement');
        const rpmInputM1 = document.getElementById('rpm');

        const powerModeRadiosM1 = document.querySelectorAll('input[name="power_mode"]');
        const powerLabelM1 = document.getElementById('power-label');
        const motorEffGroupM1 = document.getElementById('motor-eff-group'); 
        
        const capacityModeRadiosM1 = document.querySelectorAll('input[name="capacity_mode"]'); 
        const capacityLabelM1 = document.getElementById('capacity-label'); 

        // --- DOM å…ƒç´ å¼•ç”¨ (æ¨¡å¼äºŒ) ---
        const calcButtonM2 = document.getElementById('calc-button-mode-2');
        const resultsDivM2 = document.getElementById('results-mode-2');
        const calcFormM2 = document.getElementById('calc-form-mode-2');
        const printButtonM2 = document.getElementById('print-button-mode-2'); // v2.6 æ–°å¢

        const fluidSelectM2 = document.getElementById('fluid_m2');
        const fluidInfoDivM2 = document.getElementById('fluid-info-m2');

        const flowModeRadiosM2 = document.querySelectorAll('input[name="flow_mode_m2"]');
        const flowModeRpmM2 = document.getElementById('flow_mode_rpm_m2');
        const flowModeVolM2 = document.getElementById('flow_mode_vol_m2');
        const rpmInputsM2 = document.getElementById('rpm-inputs-m2');
        const volInputsM2 = document.getElementById('vol-inputs-m2');
        const flowM3hInputM2 = document.getElementById('flow_m3h_m2');
        const displacementInputM2 = document.getElementById('displacement_m2');
        const rpmInputM2 = document.getElementById('rpm_m2');
        
        const effModeRadiosM2 = document.querySelectorAll('input[name="eff_mode_m2"]');
        const effModeShaftM2 = document.getElementById('eff_mode_shaft_m2');
        const effModeInputM2 = document.getElementById('eff_mode_input_m2');
        const etaSLabelM2 = document.getElementById('eta_s_label_m2');
        const etaSInputM2 = document.getElementById('eta_s_m2');
        const etaVInputM2 = document.getElementById('eta_v_m2');
        const motorEffGroupM2 = document.getElementById('motor-eff-group-m2');
        const motorEffInputM2 = document.getElementById('motor_eff_m2');
        const tooltipEtaSM2 = document.getElementById('tooltip-eta-s-m2'); // v2.6 æ–°å¢

        const tempEvapM2 = document.getElementById('temp_evap_m2');
        const tempCondM2 = document.getElementById('temp_cond_m2');
        const superheatM2 = document.getElementById('superheat_m2');
        const subcoolingM2 = document.getElementById('subcooling_m2');

        // --- æŒ‰é’®çŠ¶æ€å¸¸é‡ ---
        const btnTextM1 = "è®¡ç®—æ•ˆç‡ (æ¨¡å¼ä¸€)";
        const btnTextM2 = "è®¡ç®—æ€§èƒ½ (æ¨¡å¼äºŒ)";
        const btnTextStaleM1 = "é‡æ–°è®¡ç®— (æ¨¡å¼ä¸€)";
        const btnTextStaleM2 = "é‡æ–°è®¡ç®— (æ¨¡å¼äºŒ)";

        const classesFreshM1 = ['bg-blue-600', 'hover:bg-blue-700', 'text-white'];
        const classesStaleM1 = ['bg-yellow-500', 'hover:bg-yellow-600', 'text-black'];
        const classesFreshM2 = ['bg-green-600', 'hover:bg-green-700', 'text-white'];
        const classesStaleM2 = ['bg-yellow-500', 'hover:bg-yellow-600', 'text-black'];

        // 2. å¼‚æ­¥åˆå§‹åŒ–ç‰©æ€§åº“
        async function initializeCoolProp() {
            try {
                const initMsg = "--- æ­£åœ¨åŠ è½½ç‰©æ€§åº“ (coolprop.js & coolprop.wasm)... ---";
                resultsDivM1.textContent = initMsg;
                resultsDivM2.textContent = initMsg;

                CP = await Module();
                
                const successMsg = "--- ç‰©æ€§åº“åŠ è½½æˆåŠŸï¼Œè¯·è¾“å…¥å‚æ•°å¹¶ç‚¹å‡»è®¡ç®— ---";
                resultsDivM1.textContent = successMsg;
                resultsDivM2.textContent = successMsg.replace("ç‚¹å‡»è®¡ç®—", "ç‚¹å‡»è®¡ç®— (æ¨¡å¼äºŒ)");

                calcButtonM1.disabled = false;
                calcButtonM1.textContent = btnTextM1;
                calcButtonM2.disabled = false;
                calcButtonM2.textContent = btnTextM2;

                updateFluidInfo(fluidSelectM1, fluidInfoDivM1);
                updateFluidInfo(fluidSelectM2, fluidInfoDivM2);

            } catch (err) {
                const errorMsg = `ç‰©æ€§åº“åŠ è½½å¤±è´¥: ${err.message}\n\nè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼Œå¹¶ç¡®ä¿ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨ (http://) è¿è¡Œã€‚`;
                resultsDivM1.textContent = errorMsg;
                resultsDivM2.textContent = errorMsg;
                fluidInfoDivM1.textContent = "ç‰©æ€§åº“åŠ è½½å¤±è´¥";
                fluidInfoDivM2.textContent = "ç‰©æ€§åº“åŠ è½½å¤±è´¥";
                console.error(err);
            }
        }

        // --- UI åˆ‡æ¢é€»è¾‘ (é€šç”¨) ---
        mode1Radio.addEventListener('change', () => {
            mode1Container.style.display = 'block';
            mode2Container.style.display = 'none';
        });
        mode2Radio.addEventListener('change', () => {
            mode1Container.style.display = 'none';
            mode2Container.style.display = 'block';
        });

        // --- UI åˆ‡æ¢é€»è¾‘ (æ¨¡å¼ä¸€) ---
        flowModeRadiosM1.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'rpm') {
                    rpmInputsM1.style.display = 'block';
                    volInputsM1.style.display = 'none';
                    displacementInputM1.required = true;
                    flowM3hInputM1.required = false;
                } else {
                    rpmInputsM1.style.display = 'none';
                    volInputsM1.style.display = 'block';
                    displacementInputM1.required = false;
                    flowM3hInputM1.required = true;
                }
            });
        });
        powerModeRadiosM1.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'shaft') {
                    powerLabelM1.textContent = 'è½´åŠŸç‡ (kW)';
                    motorEffGroupM1.style.display = 'none'; 
                } else {
                    powerLabelM1.textContent = 'è¾“å…¥åŠŸç‡ (kW) (ç”µæœº)';
                    motorEffGroupM1.style.display = 'block'; 
                }
            });
        });
        capacityModeRadiosM1.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'refrigeration') {
                    capacityLabelM1.textContent = 'åˆ¶å†·é‡ (kW)';
                } else {
                    capacityLabelM1.textContent = 'åˆ¶çƒ­é‡ (kW)';
                }
            });
        });
        fluidSelectM1.addEventListener('change', () => updateFluidInfo(fluidSelectM1, fluidInfoDivM1));

        // --- UI åˆ‡æ¢é€»è¾‘ (æ¨¡å¼äºŒ) ---
        flowModeRadiosM2.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'rpm') {
                    rpmInputsM2.style.display = 'block';
                    volInputsM2.style.display = 'none';
                    displacementInputM2.required = true;
                    flowM3hInputM2.required = false;
                } else {
                    rpmInputsM2.style.display = 'none';
                    volInputsM2.style.display = 'block';
                    displacementInputM2.required = false;
                    flowM3hInputM2.required = true;
                }
            });
        });
        effModeRadiosM2.forEach(radio => {
            radio.addEventListener('change', () => {
                // v2.6 æ›´æ–°: åŒæ­¥ä¿®æ”¹å¤‡æ³¨æç¤º
                if (radio.value === 'shaft') {
                    etaSLabelM2.childNodes[0].nodeValue = 'ç­‰ç†µæ•ˆç‡ (Î·_s) '; // æ›´æ–° Label æ–‡æœ¬
                    tooltipEtaSM2.textContent = 'åŸºäºã€è½´åŠŸç‡ã€‘ã€‚Î·_s = ç†è®ºç­‰ç†µåŠŸç‡ / å‹ç¼©æœºè½´åŠŸç‡ã€‚';
                    motorEffGroupM2.style.display = 'none'; 
                    motorEffInputM2.required = false;
                } else {
                    etaSLabelM2.childNodes[0].nodeValue = 'æ€»ç­‰ç†µæ•ˆç‡ (Î·_total) '; // æ›´æ–° Label æ–‡æœ¬
                    tooltipEtaSM2.textContent = 'åŸºäºã€è¾“å…¥åŠŸç‡ã€‘ã€‚Î·_total = ç†è®ºç­‰ç†µåŠŸç‡ / ç”µæœºè¾“å…¥åŠŸç‡ã€‚';
                    motorEffGroupM2.style.display = 'block'; 
                    motorEffInputM2.required = true;
                }
            });
        });
        fluidSelectM2.addEventListener('change', () => updateFluidInfo(fluidSelectM2, fluidInfoDivM2));

        // --- è¾…åŠ©åŠŸèƒ½ (å¯é‡ç”¨) ---
        function updateFluidInfo(selectElement, infoElement) {
            if (!CP) return; 
            const fluid = selectElement.value;
            const info = fluidInfoData[fluid]; 
            if (!info) {
                infoElement.textContent = `æœªæ‰¾åˆ° ${fluid} çš„ GWP/ODP/å®‰å…¨ä¿¡æ¯ã€‚`;
                return;
            }
            try {
                // ç‰¹æ®Šå¤„ç† R744 (CO2)
                if (fluid === 'R744') {
                    const Tcrit_K = CP.PropsSI('Tcrit', '', 0, '', 0, fluid);
                    const Pcrit_Pa = CP.PropsSI('Pcrit', '', 0, '', 0, fluid);
                    infoElement.innerHTML = `
<b>${fluid} (CO2) å…³é”®å‚æ•°:</b>
----------------------------------------
GWP (AR4/AR5): ${info.gwp}
ODP:           ${info.odp}
å®‰å…¨çº§åˆ«:      ${info.safety}
----------------------------------------
ä¸´ç•Œæ¸©åº¦ (Tc): ${Tcrit_K.toFixed(2)} K (${(Tcrit_K - 273.15).toFixed(2)} Â°C)
ä¸´ç•Œå‹åŠ› (Pc): ${(Pcrit_Pa / 1e5).toFixed(2)} bar
(æ³¨æ„: æ²¸ç‚¹ä¸ºå‡åç‚¹, ä¸é€‚ç”¨æ ‡å‡†æ²¸ç‚¹è®¡ç®—)
(è­¦å‘Š: R744 å¸¸ç”¨äºè·¨ä¸´ç•Œå¾ªç¯)
                    `.trim();
                    return;
                }

                const Tcrit_K = CP.PropsSI('Tcrit', '', 0, '', 0, fluid);
                const Pcrit_Pa = CP.PropsSI('Pcrit', '', 0, '', 0, fluid);
                const Tboil_K = CP.PropsSI('T', 'P', 101325, 'Q', 0, fluid); 
                infoElement.innerHTML = `
<b>${fluid} å…³é”®å‚æ•°:</b>
----------------------------------------
GWP (AR4/AR5): ${info.gwp}
ODP:           ${info.odp}
å®‰å…¨çº§åˆ«:      ${info.safety} (æ¯’æ€§[A/B] / å¯ç‡ƒæ€§[1/2L/2/3])
----------------------------------------
ä¸´ç•Œæ¸©åº¦ (Tc): ${Tcrit_K.toFixed(2)} K (${(Tcrit_K - 273.15).toFixed(2)} Â°C)
ä¸´ç•Œå‹åŠ› (Pc): ${(Pcrit_Pa / 1e5).toFixed(2)} bar
æ ‡å‡†æ²¸ç‚¹ (Tb): ${Tboil_K.toFixed(2)} K (${(Tboil_K - 273.15).toFixed(2)} Â°C)
                `.trim(); 
            } catch (err) {
                console.error("Update Fluid Info Failed:", err);
                if (err.message.includes("sublimation")) {
                    // å†æ¬¡ç‰¹æ®Šå¤„ç† R744
                    const Tcrit_K = CP.PropsSI('Tcrit', '', 0, '', 0, fluid);
                    const Pcrit_Pa = CP.PropsSI('Pcrit', '', 0, '', 0, fluid);
                     infoElement.innerHTML = `
<b>${fluid} (CO2) å…³é”®å‚æ•°:</b>
----------------------------------------
GWP (AR4/AR5): ${info.gwp}
ODP:           ${info.odp}
å®‰å…¨çº§åˆ«:      ${info.safety}
----------------------------------------
ä¸´ç•Œæ¸©åº¦ (Tc): ${Tcrit_K.toFixed(2)} K (${(Tcrit_K - 273.15).toFixed(2)} Â°C)
ä¸´ç•Œå‹åŠ› (Pc): ${(Pcrit_Pa / 1e5).toFixed(2)} bar
(æ³¨æ„: 1 atm ä¸‹ä¸ºå‡åç‚¹, éæ²¸ç‚¹)
(è­¦å‘Š: R744 å¸¸ç”¨äºè·¨ä¸´ç•Œå¾ªç¯)
                    `.trim();
                } else {
                    infoElement.textContent = `è·å– ${fluid} çƒ­åŠ›å­¦å‚æ•°å¤±è´¥: ${err.message}`;
                }
            }
        }
        
        function setButtonStale(button, staleText, freshClasses, staleClasses) {
            button.textContent = staleText;
            button.classList.remove(...freshClasses);
            button.classList.add(...staleClasses);
        }
        function setButtonFresh(button, freshText, freshClasses, staleClasses) {
            button.textContent = freshText;
            button.classList.remove(...staleClasses);
            button.classList.add(...freshClasses);
        }

        // --- ä¸»è®¡ç®—ä¸äº‹ä»¶ç»‘å®š ---
        calcFormM1.addEventListener('submit', (event) => {
            event.preventDefault(); 
            if (!CP) {
                resultsDivM1.textContent = "ç‰©æ€§åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚";
                return;
            }
            calculateMode1();
        });

        calcFormM2.addEventListener('submit', (event) => {
            event.preventDefault(); 
            if (!CP) {
                resultsDivM2.textContent = "ç‰©æ€§åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚";
                return;
            }
            calculateMode2();
        });

        // 11. ä¸»è®¡ç®—å‡½æ•° (æ¨¡å¼ä¸€ï¼šè¯„ä¼°)
        function calculateMode1() {
            try {
                // --- A. è·å–æ‰€æœ‰è¾“å…¥å€¼ ---
                const fluid = fluidSelectM1.value;
                const flow_mode = document.querySelector('input[name="flow_mode"]:checked').value;
                const power_mode = document.querySelector('input[name="power_mode"]:checked').value;
                const capacity_mode = document.querySelector('input[name="capacity_mode"]:checked').value; 
                const rpm_val = parseFloat(rpmInputM1.value);
                const Q_input_kW = parseFloat(document.getElementById('capacity').value); 
                const Win_box_kW = parseFloat(document.getElementById('power').value);
                const motor_eff_val = parseFloat(document.getElementById('motor_eff').value); 
                const Te_C = parseFloat(document.getElementById('temp_evap').value);
                const Tc_C = parseFloat(document.getElementById('temp_cond').value);
                const dT_sh_K = parseFloat(document.getElementById('superheat').value);
                const dT_sc_K = parseFloat(document.getElementById('subcooling').value);
                if (isNaN(rpm_val) || isNaN(Q_input_kW) || isNaN(Win_box_kW) || isNaN(Te_C) || isNaN(Tc_C) || isNaN(dT_sh_K) || isNaN(dT_sc_K)) {
                    throw new Error("è¾“å…¥åŒ…å«æ— æ•ˆæ•°å­—ï¼Œè¯·æ£€æŸ¥æ‰€æœ‰å­—æ®µã€‚");
                }
                
                // --- B. å•ä½è½¬æ¢ ---
                const Te_K = Te_C + 273.15;
                const Tc_K = Tc_C + 273.15;
                const Q_input_W = Q_input_kW * 1000;
                const Win_box_W = Win_box_kW * 1000; 

                // --- C. åŠŸç‡å’Œå®¹é‡è®¡ç®— ---
                let W_shaft_W; 
                let Win_input_W;
                if (power_mode === 'shaft') {
                    W_shaft_W = Win_box_W; 
                    Win_input_W = NaN; 
                } else {
                    Win_input_W = Win_box_W;
                    W_shaft_W = Win_input_W * motor_eff_val;
                }
                let Qe_W;
                let Qh_W; 
                if (capacity_mode === 'refrigeration') {
                    Qe_W = Q_input_W;
                    Qh_W = Qe_W + W_shaft_W;
                } else { 
                    Qh_W = Q_input_W;
                    Qe_W = Qh_W - W_shaft_W;
                }
                if (Qe_W <= 0) {
                    throw new Error(`è®¡ç®—çš„åˆ¶å†·é‡ (Qe = Qh - W_shaft) å°äºç­‰äºé›¶ (${(Qe_W/1000).toFixed(2)} kW)ã€‚è¯·æ£€æŸ¥è¾“å…¥ã€‚`);
                }

                // --- D. ç†è®ºä½“ç§¯æµé‡ (mÂ³/s) ---
                let V_th_m3_s;
                let V_rev_cm3_val = NaN, V_th_m3_h_val = NaN;
                if (flow_mode === 'rpm') {
                    V_rev_cm3_val = parseFloat(displacementInputM1.value);
                    if (isNaN(V_rev_cm3_val)) throw new Error("è¯·æ£€æŸ¥æ¯è½¬æ’é‡è¾“å…¥ã€‚");
                    if (rpm_val <= 0) throw new Error("è½¬é€Ÿå¿…é¡»å¤§äº 0ã€‚");
                    V_th_m3_s = (V_rev_cm3_val / 1e6) * (rpm_val / 60);
                    V_th_m3_h_val = V_th_m3_s * 3600;
                } else { 
                    V_th_m3_h_val = parseFloat(flowM3hInputM1.value);
                    if (isNaN(V_th_m3_h_val)) throw new Error("è¯·æ£€æŸ¥ä½“ç§¯æµé‡è¾“å…¥ã€‚");
                    if (rpm_val <= 0) throw new Error("è½¬é€Ÿå¿…é¡»å¤§äº 0ã€‚");
                    V_th_m3_s = V_th_m3_h_val / 3600;
                    V_rev_cm3_val = (V_th_m3_s * 60 / rpm_val) * 1e6;
                }
                if (V_th_m3_s <= 0) throw new Error("ç†è®ºæ’é‡å¿…é¡»å¤§äºé›¶ã€‚");

                // --- E. è®¡ç®—ç¨³å®šçŠ¶æ€ç‚¹ (1, 3, 4) ---
                const Pe_Pa = CP.PropsSI('P', 'T', Te_K, 'Q', 1, fluid);
                const T1_K = Te_K + dT_sh_K;
                const h1_J_kg = CP.PropsSI('H', 'T', T1_K, 'P', Pe_Pa, fluid);
                const s1_J_kgK = CP.PropsSI('S', 'T', T1_K, 'P', Pe_Pa, fluid);
                const rho1_kg_m3 = CP.PropsSI('D', 'T', T1_K, 'P', Pe_Pa, fluid);
                const v1_m3_kg = 1 / rho1_kg_m3;
                const Pc_Pa = CP.PropsSI('P', 'T', Tc_K, 'Q', 0, fluid);
                const T3_K = Tc_K - dT_sc_K;
                const h3_J_kg = CP.PropsSI('H', 'T', T3_K, 'P', Pc_Pa, fluid);
                const h4_J_kg = h3_J_kg; 

                // --- F. è®¡ç®—ç¨³å®šçš„æ€§èƒ½å‚æ•° (è´¨é‡æµ, å®¹ç§¯æ•ˆç‡) ---
                const h_evap_J_kg = h1_J_kg - h4_J_kg;
                if (h_evap_J_kg <= 0) throw new Error("è®¡ç®—å‡ºé”™ï¼šåˆ¶å†·ç„“å·®å°äºç­‰äºé›¶ã€‚");
                const m_dot_kg_s = Qe_W / h_evap_J_kg; 
                const V_actual_m3_s = m_dot_kg_s * v1_m3_kg;
                const eta_v = (V_actual_m3_s / V_th_m3_s);

                // --- G. è®¡ç®—ä¸¤ç§æ•ˆç‡ ---
                let Ws_W, h2s_J_kg, T2s_K, T2s_C; // v2.7 å¢åŠ  T2s
                let eta_s_shaft = NaN; 
                let eta_s_total = NaN; 
                let isentropic_error_msg = null;
                try {
                    h2s_J_kg = CP.PropsSI('H', 'P', Pc_Pa, 'S', s1_J_kgK, fluid); 
                    T2s_K = CP.PropsSI('T', 'P', Pc_Pa, 'S', s1_J_kgK, fluid); // v2.7 è®¡ç®— T2s
                    T2s_C = T2s_K - 273.15; // v2.7
                    
                    const h_isen_J_kg = h2s_J_kg - h1_J_kg;
                    if (h_isen_J_kg <= 0) throw new Error("ç†è®ºç­‰ç†µç„“å‡å°äºç­‰äºé›¶, å·¥å†µé”™è¯¯ã€‚");
                    Ws_W = m_dot_kg_s * h_isen_J_kg; 
                    if (W_shaft_W <= 0) throw new Error("è®¡ç®—å‡ºçš„è½´åŠŸç‡å¿…é¡»å¤§äºé›¶ã€‚");
                    eta_s_shaft = Ws_W / W_shaft_W;
                    if (power_mode === 'input') {
                        if (Win_input_W <= 0) throw new Error("è¾“å…¥åŠŸç‡å¿…é¡»å¤§äºé›¶ã€‚");
                        eta_s_total = Ws_W / Win_input_W;
                    }
                } catch (isen_error) {
                    console.error("Isentropic calculation failed (Mode 1):", isen_error);
                    isentropic_error_msg = `è®¡ç®—å¤±è´¥ (${isen_error.message})`;
                    Ws_W = NaN;
                    h2s_J_kg = NaN;
                    T2s_K = NaN; T2s_C = NaN; // v2.7
                    eta_s_shaft = NaN; 
                    eta_s_total = NaN;
                }

                // --- G.2 (v2.7) è®¡ç®—å®é™…æ’æ°”æ¸©åº¦ T2a ---
                let T2a_K = NaN, T2a_C = NaN, h2a_J_kg = NaN;
                let actual_temp_error_msg = null;
                try {
                    if (m_dot_kg_s <= 0) throw new Error("è´¨é‡æµé‡ä¸ºé›¶ï¼Œæ— æ³•è®¡ç®—ã€‚");
                    h2a_J_kg = (W_shaft_W / m_dot_kg_s) + h1_J_kg;
                    T2a_K = CP.PropsSI('T', 'P', Pc_Pa, 'H', h2a_J_kg, fluid);
                    T2a_C = T2a_K - 273.15;
                } catch (actual_temp_error) {
                    console.error("Actual temp calculation failed (Mode 1):", actual_temp_error);
                    actual_temp_error_msg = `è®¡ç®—å¤±è´¥ (${actual_temp_error.message})`;
                    T2a_K = NaN; T2a_C = NaN; h2a_J_kg = NaN;
                }

                // --- H. æ ¼å¼åŒ–è¾“å‡º ---
                const powerInputLabel = (power_mode === 'shaft') ? `è½´åŠŸç‡ (Win)` : `è¾“å…¥åŠŸç‡ (Win)`;
                const capacityInputLabel = (capacity_mode === 'refrigeration') ? `åˆ¶å†·é‡ (Qe)` : `åˆ¶çƒ­é‡ (Qh)`;

                let output = `
--- è®¡ç®—æ¦‚è§ˆ (å·¥è´¨: ${fluid}) ---
è’¸å‘å‹åŠ› (Pe): ${(Pe_Pa / 1e5).toFixed(3)} bar
å†·å‡å‹åŠ› (Pc): ${(Pc_Pa / 1e5).toFixed(3)} bar
å‹ç¼©æ¯” (PR):   ${(Pc_Pa / Pe_Pa).toFixed(2)}

--- å…³é”®çŠ¶æ€ç‚¹ ---
çŠ¶æ€ 1 (å…¥å£):
  T1 = ${T1_K.toFixed(2)} K (${(T1_K - 273.15).toFixed(2)} Â°C)
  h1 = ${(h1_J_kg / 1000).toFixed(2)} kJ/kg
  s1 = ${(s1_J_kgK / 1000).toFixed(4)} kJ/kgÂ·K
  v1 = ${v1_m3_kg.toFixed(5)} mÂ³/kg
çŠ¶æ€ 3 (é˜€å‰):
  T3 = ${T3_K.toFixed(2)} K (${(T3_K - 273.15).toFixed(2)} Â°C)
  h3 = ${(h3_J_kg / 1000).toFixed(2)} kJ/kg
çŠ¶æ€ 2s (ç­‰ç†µå‡ºå£):
  T2s = ${isNaN(T2s_C) ? `N/A (${isentropic_error_msg})` : `${T2s_C.toFixed(2)} Â°C`}
  h2s = ${isNaN(h2s_J_kg) ? `N/A (${isentropic_error_msg})` : `${(h2s_J_kg / 1000).toFixed(2)} kJ/kg`}
çŠ¶æ€ 2a (å®é™…å‡ºå£):
  T2a = ${isNaN(T2a_C) ? `N/A (${actual_temp_error_msg})` : `${T2a_C.toFixed(2)} Â°C`}
  h2a = ${isNaN(h2a_J_kg) ? `N/A (${actual_temp_error_msg})` : `${(h2a_J_kg / 1000).toFixed(2)} kJ/kg`}

--- åŠŸç‡ä¸å®¹é‡ (åŸºäºèƒ½é‡å¹³è¡¡) ---
è¾“å…¥ ${capacityInputLabel}: ${Q_input_kW.toFixed(3)} kW
è¾“å…¥ ${powerInputLabel}: ${Win_box_kW.toFixed(3)} kW
${(power_mode === 'input') ? `ç”µæœºæ•ˆç‡:       ${(motor_eff_val * 100).toFixed(1)} %` : ''}
${(power_mode === 'input') ? `è®¡ç®—è½´åŠŸç‡:     ${(W_shaft_W / 1000).toFixed(3)} kW` : ''}

è®¡ç®— ${capacity_mode === 'refrigeration' ? 'åˆ¶çƒ­é‡ (Qh)' : 'åˆ¶å†·é‡ (Qe)'}: ${capacity_mode === 'refrigeration' ? (Qh_W / 1000).toFixed(3) : (Qe_W / 1000).toFixed(3)} kW

--- æµé‡ä¸ç­‰ç†µåŠŸç‡ ---
åˆ¶å†·ç„“å·®:     ${(h_evap_J_kg / 1000).toFixed(2)} kJ/kg
è´¨é‡æµé‡ (m_dot): ${m_dot_kg_s.toFixed(5)} kg/s
ç­‰ç†µåŠŸç‡ (Ws):   ${isNaN(Ws_W) ? 'N/A' : `${(Ws_W / 1000).toFixed(3)} kW`}

--- ä½“ç§¯æµé‡ (è½¬é€Ÿ: ${rpm_val.toFixed(0)} RPM) ---
`;
                if (flow_mode === 'rpm') {
                    output += `è¾“å…¥æ’é‡:     ${V_rev_cm3_val.toFixed(1)} cmÂ³/rev\n`;
                    output += `è®¡ç®—æµé‡:     ${V_th_m3_h_val.toFixed(2)} mÂ³/h\n`;
                } else {
                    output += `è¾“å…¥æµé‡:     ${V_th_m3_h_val.toFixed(2)} mÂ³/h\n`;
                    output += `è®¡ç®—æ’é‡:     ${V_rev_cm3_val.toFixed(1)} cmÂ³/rev\n`;
                }
                output += `
ç†è®ºä½“ç§¯æµé‡ (V_th): ${V_th_m3_s.toFixed(6)} mÂ³/s
å®é™…ä½“ç§¯æµé‡ (V_act): ${V_actual_m3_s.toFixed(6)} mÂ³/s

========================================
           æœ€ç»ˆæ•ˆç‡è®¡ç®— (å¤‡æ³¨)
========================================
ç­‰ç†µæ•ˆç‡ (Î·_s):       ${isNaN(eta_s_shaft) ? 'N/A' : `${(eta_s_shaft * 100).toFixed(2)} %`}\n`;
                output += `  (å¤‡æ³¨: ç†è®ºç­‰ç†µåŠŸç‡ / å®é™…è½´åŠŸç‡)\n`; // v2.6 å¤‡æ³¨

                if (power_mode === 'input') {
                    output += `æ€»ç­‰ç†µæ•ˆç‡ (Î·_total):   ${isNaN(eta_s_total) ? 'N/A' : `${(eta_s_total * 100).toFixed(2)} %`}\n`;
                    output += `  (å¤‡æ³¨: ç†è®ºç­‰ç†µåŠŸç‡ / ç”µæœºè¾“å…¥åŠŸç‡)\n`; // v2.6 å¤‡æ³¨
                }
                
                output += `å®¹ç§¯æ•ˆç‡ (Î·_v):         ${(eta_v * 100).toFixed(2)} %`;
                output += `\n  (å¤‡æ³¨: å®é™…å¸æ°”ä½“ç§¯æµé‡ / ç†è®ºè¾“æ°”é‡)`; // v2.6 å¤‡æ³¨

                resultsDivM1.textContent = output;
                lastMode1ResultText = output; // v2.6 å­˜å‚¨çº¯æ–‡æœ¬

                // ç¼“å­˜ç»“æœå¹¶å¯ç”¨è½¬æ¢æŒ‰é’®
                lastMode1Results = {
                    fluid,
                    rpm_val,
                    flow_mode,
                    V_rev_cm3_val,
                    V_th_m3_h_val,
                    Te_C,
                    Tc_C,
                    dT_sh_K,
                    dT_sc_K,
                    power_mode,
                    motor_eff_val,
                    eta_v: isNaN(eta_v) ? null : eta_v,
                    eta_s_shaft: isNaN(eta_s_shaft) ? null : eta_s_shaft,
                    eta_s_total: isNaN(eta_s_total) ? null : eta_s_total
                };
                transferButton.disabled = false;
                printButtonM1.disabled = false; // v2.6 å¯ç”¨æ‰“å°

                setButtonFresh(calcButtonM1, btnTextM1, classesFreshM1, classesStaleM1);

            } catch (error) {
                resultsDivM1.textContent = `è®¡ç®—å‡ºé”™: ${error.message}\n\nè¯·æ£€æŸ¥è¾“å…¥å‚æ•°æ˜¯å¦åœ¨å·¥è´¨çš„æœ‰æ•ˆèŒƒå›´å†…ã€‚`;
                console.error(error);
                
                lastMode1Results = null;
                lastMode1ResultText = null;
                transferButton.disabled = true;
                printButtonM1.disabled = true;
            }
        }

        // 11_M2. ä¸»è®¡ç®—å‡½æ•° (æ¨¡å¼äºŒï¼šé¢„æµ‹)
        function calculateMode2() {
            try {
                // --- A. è·å–æ‰€æœ‰è¾“å…¥å€¼ ---
                const fluid = fluidSelectM2.value;
                const flow_mode = document.querySelector('input[name="flow_mode_m2"]:checked').value;
                const eff_mode = document.querySelector('input[name="eff_mode_m2"]:checked').value;
                const rpm_val = parseFloat(rpmInputM2.value);
                const eta_s_input = parseFloat(etaSInputM2.value);
                const eta_v_input = parseFloat(etaVInputM2.value);
                const motor_eff_val = parseFloat(motorEffInputM2.value);
                const Te_C = parseFloat(tempEvapM2.value);
                const Tc_C = parseFloat(tempCondM2.value);
                const dT_sh_K = parseFloat(superheatM2.value);
                const dT_sc_K = parseFloat(subcoolingM2.value);
                if (isNaN(rpm_val) || isNaN(eta_s_input) || isNaN(eta_v_input) || isNaN(Te_C) || isNaN(Tc_C) || isNaN(dT_sh_K) || isNaN(dT_sc_K)) {
                    throw new Error("è¾“å…¥åŒ…å«æ— æ•ˆæ•°å­—ï¼Œè¯·æ£€æŸ¥æ‰€æœ‰å­—æ®µã€‚");
                }
                if (eff_mode === 'input' && isNaN(motor_eff_val)) {
                    throw new Error("åœ¨'åŸºäºè¾“å…¥åŠŸç‡'æ¨¡å¼ä¸‹ï¼Œå¿…é¡»æä¾›æœ‰æ•ˆçš„ç”µæœºæ•ˆç‡ã€‚");
                }

                // --- B. å•ä½è½¬æ¢ ---
                const Te_K = Te_C + 273.15;
                const Tc_K = Tc_C + 273.15;

                // --- C. ç†è®ºä½“ç§¯æµé‡ (mÂ³/s) ---
                let V_th_m3_s;
                let V_rev_cm3_val = NaN, V_th_m3_h_val = NaN;
                if (flow_mode === 'rpm') {
                    V_rev_cm3_val = parseFloat(displacementInputM2.value);
                    if (isNaN(V_rev_cm3_val)) throw new Error("è¯·æ£€æŸ¥æ¯è½¬æ’é‡è¾“å…¥ã€‚");
                    if (rpm_val <= 0) throw new Error("è½¬é€Ÿå¿…é¡»å¤§äº 0ã€‚");
                    V_th_m3_s = (V_rev_cm3_val / 1e6) * (rpm_val / 60);
                    V_th_m3_h_val = V_th_m3_s * 3600;
                } else { 
                    V_th_m3_h_val = parseFloat(flowM3hInputM2.value);
                    if (isNaN(V_th_m3_h_val)) throw new Error("è¯·æ£€æŸ¥ä½“ç§¯æµé‡è¾“å…¥ã€‚");
                    if (rpm_val <= 0) throw new Error("è½¬é€Ÿå¿…é¡»å¤§äº 0ã€‚");
                    V_th_m3_s = V_th_m3_h_val / 3600;
                    V_rev_cm3_val = (V_th_m3_s * 60 / rpm_val) * 1e6;
                }
                if (V_th_m3_s <= 0) throw new Error("ç†è®ºæ’é‡å¿…é¡»å¤§äºé›¶ã€‚");

                // --- D. è®¡ç®—çŠ¶æ€ç‚¹ (1, 3, 4) ---
                const Pe_Pa = CP.PropsSI('P', 'T', Te_K, 'Q', 1, fluid);
                const T1_K = Te_K + dT_sh_K;
                const h1_J_kg = CP.PropsSI('H', 'T', T1_K, 'P', Pe_Pa, fluid);
                const s1_J_kgK = CP.PropsSI('S', 'T', T1_K, 'P', Pe_Pa, fluid);
                const rho1_kg_m3 = CP.PropsSI('D', 'T', T1_K, 'P', Pe_Pa, fluid);
                const v1_m3_kg = 1 / rho1_kg_m3;
                const Pc_Pa = CP.PropsSI('P', 'T', Tc_K, 'Q', 0, fluid);
                const T3_K = Tc_K - dT_sc_K;
                const h3_J_kg = CP.PropsSI('H', 'T', T3_K, 'P', Pc_Pa, fluid);
                const h4_J_kg = h3_J_kg; 

                // --- E. è®¡ç®—ç†è®ºæ¯”ç„“ (å’Œ T2s) ---
                const h_evap_J_kg = h1_J_kg - h4_J_kg;
                if (h_evap_J_kg <= 0) throw new Error("è®¡ç®—å‡ºé”™ï¼šåˆ¶å†·ç„“å·®å°äºç­‰äºé›¶ã€‚");
                let h_isen_J_kg, h2s_J_kg, T2s_K, T2s_C; // v2.7 å¢åŠ  T2s
                let isentropic_error_msg = null;
                try {
                    h2s_J_kg = CP.PropsSI('H', 'P', Pc_Pa, 'S', s1_J_kgK, fluid);
                    T2s_K = CP.PropsSI('T', 'P', Pc_Pa, 'S', s1_J_kgK, fluid); // v2.7
                    T2s_C = T2s_K - 273.15; // v2.7
                    h_isen_J_kg = h2s_J_kg - h1_J_kg;
                    if (h_isen_J_kg <= 0) throw new Error("ç†è®ºç­‰ç†µç„“å‡å°äºç­‰äºé›¶, å·¥å†µé”™è¯¯ã€‚");
                } catch (isen_error) {
                    console.error("Isentropic calculation failed (Mode 2):", isen_error);
                    isentropic_error_msg = `è®¡ç®—å¤±è´¥ (${isen_error.message})`;
                    T2s_K = NaN; T2s_C = NaN; // v2.7
                    throw new Error(`ç­‰ç†µç‚¹è®¡ç®—å¤±è´¥: ${isentropic_error_msg}`);
                }

                // --- F. åº”ç”¨æ•ˆç‡ (æ ¸å¿ƒé€»è¾‘) ---
                const V_actual_m3_s = V_th_m3_s * eta_v_input;
                const m_dot_kg_s = V_actual_m3_s / v1_m3_kg;
                const Ws_W = m_dot_kg_s * h_isen_J_kg;

                // --- G. è®¡ç®—å®é™…åŠŸç‡ ---
                let W_shaft_W, Win_input_W = NaN;
                let eta_s_shaft = NaN, eta_s_total = NaN;
                if (eff_mode === 'input') {
                    eta_s_total = eta_s_input; 
                    Win_input_W = Ws_W / eta_s_total;
                    W_shaft_W = Win_input_W * motor_eff_val;
                    eta_s_shaft = Ws_W / W_shaft_W; 
                } else { 
                    eta_s_shaft = eta_s_input; 
                    W_shaft_W = Ws_W / eta_s_shaft;
                    eta_s_total = NaN;
                }

                // --- H. è®¡ç®—å®é™…å®¹é‡ ---
                const Qe_W = m_dot_kg_s * h_evap_J_kg;
                const Qh_W = Qe_W + W_shaft_W; 

                // --- H.2 (v2.7) è®¡ç®—å®é™…æ’æ°”æ¸©åº¦ T2a ---
                let T2a_K = NaN, T2a_C = NaN, h2a_J_kg = NaN;
                let actual_temp_error_msg = null;
                try {
                    if (m_dot_kg_s <= 0) throw new Error("è´¨é‡æµé‡ä¸ºé›¶ï¼Œæ— æ³•è®¡ç®—ã€‚");
                    h2a_J_kg = (W_shaft_W / m_dot_kg_s) + h1_J_kg;
                    T2a_K = CP.PropsSI('T', 'P', Pc_Pa, 'H', h2a_J_kg, fluid);
                    T2a_C = T2a_K - 273.15;
                } catch (actual_temp_error) {
                    console.error("Actual temp calculation failed (Mode 2):", actual_temp_error);
                    actual_temp_error_msg = `è®¡ç®—å¤±è´¥ (${actual_temp_error.message})`;
                    T2a_K = NaN; T2a_C = NaN; h2a_J_kg = NaN;
                }

                // --- I. è®¡ç®— COP ---
                const COP_R = Qe_W / W_shaft_W;
                const COP_H = Qh_W / W_shaft_W;
                const EER_R = isNaN(Win_input_W) ? NaN : (Qe_W / Win_input_W);
                const EER_H = isNaN(Win_input_W) ? NaN : (Qh_W / Win_input_W);

                // --- J. æ ¼å¼åŒ–è¾“å‡º ---
                let output = `
--- è®¡ç®—æ¦‚è§ˆ (å·¥è´¨: ${fluid}) ---
è’¸å‘å‹åŠ› (Pe): ${(Pe_Pa / 1e5).toFixed(3)} bar
å†·å‡å‹åŠ› (Pc): ${(Pc_Pa / 1e5).toFixed(3)} bar
å‹ç¼©æ¯” (PR):   ${(Pc_Pa / Pe_Pa).toFixed(2)}

--- å…³é”®çŠ¶æ€ç‚¹ ---
çŠ¶æ€ 1 (å…¥å£):
  T1 = ${T1_K.toFixed(2)} K (${(T1_K - 273.15).toFixed(2)} Â°C)
  v1 = ${v1_m3_kg.toFixed(5)} mÂ³/kg
  h1 = ${(h1_J_kg / 1000).toFixed(2)} kJ/kg
çŠ¶æ€ 3 (é˜€å‰):
  h3 = ${(h3_J_kg / 1000).toFixed(2)} kJ/kg
çŠ¶æ€ 2s (ç­‰ç†µå‡ºå£):
  T2s = ${isNaN(T2s_C) ? 'N/A' : `${T2s_C.toFixed(2)} Â°C`}
  h2s = ${(h2s_J_kg / 1000).toFixed(2)} kJ/kg
çŠ¶æ€ 2a (å®é™…å‡ºå£):
  T2a = ${isNaN(T2a_C) ? `N/A (${actual_temp_error_msg})` : `${T2a_C.toFixed(2)} Â°C`}
  h2a = ${isNaN(h2a_J_kg) ? `N/A (${actual_temp_error_msg})` : `${(h2a_J_kg / 1000).toFixed(2)} kJ/kg`}

--- ç†è®ºæµé‡ä¸æ¯”ç„“ ---
åˆ¶å†·ç„“å·®:     ${(h_evap_J_kg / 1000).toFixed(2)} kJ/kg
ç­‰ç†µç„“å‡:     ${(h_isen_J_kg / 1000).toFixed(2)} kJ/kg
`;
                if (flow_mode === 'rpm') {
                    output += `è¾“å…¥æ’é‡:     ${V_rev_cm3_val.toFixed(1)} cmÂ³/rev ( @ ${rpm_val.toFixed(0)} RPM )\n`;
                    output += `ç†è®ºæµé‡(V_th): ${V_th_m3_h_val.toFixed(2)} mÂ³/h\n`;
                } else {
                    output += `è¾“å…¥æµé‡(V_th): ${V_th_m3_h_val.toFixed(2)} mÂ³/h\n`;
                    output += `è®¡ç®—æ’é‡:     ${V_rev_cm3_val.toFixed(1)} cmÂ³/rev ( @ ${rpm_val.toFixed(0)} RPM )\n`;
                }
output += `
--- è¾“å…¥æ•ˆç‡ ---
å®¹ç§¯æ•ˆç‡ (Î·_v):         ${(eta_v_input * 100).toFixed(2)} %
${(eff_mode === 'shaft') ? `ç­‰ç†µæ•ˆç‡ (Î·_s):       ${(eta_s_shaft * 100).toFixed(2)} %` : `æ€»ç­‰ç†µæ•ˆç‡ (Î·_total):   ${(eta_s_total * 100).toFixed(2)} %`}
${(eff_mode === 'input') ? `ç”µæœºæ•ˆç‡:             ${(motor_eff_val * 100).toFixed(1)} %` : ''}
${(eff_mode === 'input') ? `(è®¡ç®—çš„ Î·_s):         ${(eta_s_shaft * 100).toFixed(2)} %` : ''}

--- å®é™…æµé‡ ---
å®é™…ä½“ç§¯æµé‡ (V_act): ${(V_actual_m3_s * 3600).toFixed(2)} mÂ³/h
å®é™…è´¨é‡æµé‡ (m_dot): ${m_dot_kg_s.toFixed(5)} kg/s
ç†è®ºç­‰ç†µåŠŸç‡ (Ws):   ${(Ws_W / 1000).toFixed(3)} kW

========================================
           æœ€ç»ˆæ€§èƒ½è®¡ç®— (å¤‡æ³¨)
========================================
åˆ¶å†·é‡ (Qe):     ${(Qe_W / 1000).toFixed(2)} kW
åˆ¶çƒ­é‡ (Qh):     ${(Qh_W / 1000).toFixed(2)} kW
è½´åŠŸç‡ (W_shaft): ${(W_shaft_W / 1000).toFixed(2)} kW
${isNaN(Win_input_W) ? '' : `è¾“å…¥åŠŸç‡ (W_in):  ${(Win_input_W / 1000).toFixed(2)} kW`}

COP (åˆ¶å†·):      ${COP_R.toFixed(3)}
  (å¤‡æ³¨: Qe / W_shaft)
COP (åˆ¶çƒ­):      ${COP_H.toFixed(3)}
  (å¤‡æ³¨: Qh / W_shaft)
${isNaN(EER_R) ? '' : `æ€» COP (åˆ¶å†·):   ${EER_R.toFixed(3)}
  (å¤‡æ³¨: Qe / W_in)`}
${isNaN(EER_H) ? '' : `æ€» COP (åˆ¶çƒ­):   ${EER_H.toFixed(3)}
  (å¤‡æ³¨: Qh / W_in)`}
`;
                resultsDivM2.textContent = output;
                lastMode2ResultText = output; // v2.6 å­˜å‚¨çº¯æ–‡æœ¬

                setButtonFresh(calcButtonM2, btnTextM2, classesFreshM2, classesStaleM2);
                printButtonM2.disabled = false; // v2.6 å¯ç”¨æ‰“å°

            } catch (error) {
                resultsDivM2.textContent = `è®¡ç®—å‡ºé”™: ${error.message}\n\nè¯·æ£€æŸ¥è¾“å…¥å‚æ•°æ˜¯å¦åœ¨å·¥è´¨çš„æœ‰æ•ˆèŒƒå›´å†…ã€‚`;
                console.error(error);
                lastMode2ResultText = null;
                printButtonM2.disabled = true;
            }
        }

        // 12. é¡µé¢åŠ è½½æ—¶ï¼Œç¦ç”¨æŒ‰é’®å¹¶å¼€å§‹åˆå§‹åŒ–
        calcButtonM1.disabled = true;
        calcButtonM2.disabled = true;
        initializeCoolProp();

        // --- ç›‘å¬æ‰€æœ‰è¾“å…¥å˜åŒ–ï¼Œç”¨äºè®¾ç½®æŒ‰é’®â€œè„â€çŠ¶æ€ ---
        const allInputsM1 = calcFormM1.querySelectorAll('input, select');
        const allInputsM2 = calcFormM2.querySelectorAll('input, select');

        allInputsM1.forEach(input => {
            const handler = () => {
                setButtonStale(calcButtonM1, btnTextStaleM1, classesFreshM1, classesStaleM1);
                transferButton.disabled = true;
                lastMode1Results = null;
                // v2.6 æ–°å¢: ç¦ç”¨æ‰“å°å¹¶æ¸…é™¤ç¼“å­˜
                printButtonM1.disabled = true;
                lastMode1ResultText = null;
            };
            input.addEventListener('input', handler);
            input.addEventListener('change', handler);
        });

        allInputsM2.forEach(input => {
            const handler = () => {
                setButtonStale(calcButtonM2, btnTextStaleM2, classesFreshM2, classesStaleM2);
                // v2.6 æ–°å¢: ç¦ç”¨æ‰“å°å¹¶æ¸…é™¤ç¼“å­˜
                printButtonM2.disabled = true;
                lastMode2ResultText = null;
            };
            input.addEventListener('input', handler);
            input.addEventListener('change', handler);
        });
        
        // --- è½¬æ¢æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ ---
        transferButton.addEventListener('click', () => {
            if (!lastMode1Results) {
                alert("æ²¡æœ‰å¯ä»£å…¥çš„æ•°æ®ã€‚è¯·å…ˆåœ¨æ¨¡å¼ä¸€ä¸­æˆåŠŸè®¡ç®—ã€‚");
                return;
            }
            
            const data = lastMode1Results;

            // 1. ä»£å…¥é€šç”¨å·¥å†µ
            fluidSelectM2.value = data.fluid;
            rpmInputM2.value = data.rpm_val;
            tempEvapM2.value = data.Te_C;
            tempCondM2.value = data.Tc_C;
            superheatM2.value = data.dT_sh_K;
            subcoolingM2.value = data.dT_sc_K;
            
            // 2. ä»£å…¥æµé‡æ¨¡å¼
            if (data.flow_mode === 'rpm') {
                flowModeRpmM2.checked = true;
                displacementInputM2.value = data.V_rev_cm3_val;
                flowModeRpmM2.dispatchEvent(new Event('change'));
            } else {
                flowModeVolM2.checked = true;
                flowM3hInputM2.value = data.V_th_m3_h_val;
                flowModeVolM2.dispatchEvent(new Event('change'));
            }

            // 3. ä»£å…¥æ ¸å¿ƒæ•ˆç‡ (æ™ºèƒ½åˆ¤æ–­)
            if (data.eta_v === null) {
                alert("è­¦å‘Š: æ¨¡å¼ä¸€æœªèƒ½ç®—å‡ºæœ‰æ•ˆçš„å®¹ç§¯æ•ˆç‡ (Î·_v)ã€‚");
                etaVInputM2.value = 0.85; // å¡«å…¥é»˜è®¤å€¼
            } else {
                etaVInputM2.value = data.eta_v.toFixed(3);
            }
            
            if (data.power_mode === 'input' && data.eta_s_total !== null) {
                // åŸºäºè¾“å…¥åŠŸç‡
                effModeInputM2.checked = true;
                etaSInputM2.value = data.eta_s_total.toFixed(3);
                motorEffInputM2.value = data.motor_eff_val;
                effModeInputM2.dispatchEvent(new Event('change'));
                
            } else if (data.power_mode === 'shaft' && data.eta_s_shaft !== null) {
                // åŸºäºè½´åŠŸç‡
                effModeShaftM2.checked = true;
                etaSInputM2.value = data.eta_s_shaft.toFixed(3);
                effModeShaftM2.dispatchEvent(new Event('change'));

            } else if (data.eta_s_shaft !== null) {
                // v2.7 ä¿®æ­£: å³ä½¿æ¨¡å¼ä¸€æ˜¯ input, ä½†å¦‚æœ eta_s_total å¤±è´¥äº†, ä»ç„¶å°è¯•ä½¿ç”¨ eta_s_shaft
                effModeShaftM2.checked = true;
                etaSInputM2.value = data.eta_s_shaft.toFixed(3);
                effModeShaftM2.dispatchEvent(new Event('change'));
                
            } else {
                // æ¨¡å¼ä¸€è®¡ç®—å¤±è´¥æˆ–æ¨¡å¼æœªçŸ¥
                alert("è­¦å‘Š: æ¨¡å¼ä¸€æœªèƒ½ç®—å‡ºæœ‰æ•ˆçš„ç­‰ç†µæ•ˆç‡ (Î·_s)ã€‚å°†ä½¿ç”¨é»˜è®¤å€¼ã€‚");
                effModeShaftM2.checked = true;
                etaSInputM2.value = 0.7; // å¡«å…¥é»˜è®¤å€¼
                effModeShaftM2.dispatchEvent(new Event('change'));
            }

            // 4. æ›´æ–°åˆ¶å†·å‰‚ä¿¡æ¯
            updateFluidInfo(fluidSelectM2, fluidInfoDivM2);
            
            // 5. è‡ªåŠ¨åˆ‡æ¢è§†å›¾
            mode2Radio.checked = true;
            mode2Radio.dispatchEvent(new Event('change'));
            
            // 6. è§¦å‘æ¨¡å¼äºŒâ€œè„æ£€æŸ¥â€
            setButtonStale(calcButtonM2, btnTextStaleM2, classesFreshM2, classesStaleM2);
            
            // æç¤ºç”¨æˆ·
            resultsDivM2.textContent = "--- æ•°æ®å·²ä»æ¨¡å¼ä¸€ä»£å…¥ --- \n--- è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è®¡ç®—æ€§èƒ½ ---";
        });
        
        // --- v2.6 æ–°å¢: æ‰“å°åŠŸèƒ½ ---
        
        /**
         * æ‰“å°æŠ¥å‘Šçš„æ ¸å¿ƒå‡½æ•°
         * @param {string} printHtml - è¦æ‰“å°çš„ HTML å†…å®¹
         */
        function callPrint(printHtml) {
            // 1. æŸ¥æ‰¾æˆ–åˆ›å»ºæ‰“å°å®¹å™¨
            let printContainer = document.getElementById('print-container');
            if (printContainer) {
                printContainer.remove(); // ç§»é™¤æ—§çš„
            }
            printContainer = document.createElement('div');
            printContainer.id = 'print-container';
            printContainer.innerHTML = printHtml;
            
            // 2. å°†å®¹å™¨æ·»åŠ åˆ° body
            document.body.appendChild(printContainer);

            // 3. è°ƒç”¨æ‰“å°
            window.print();

            // 4. æ‰“å°åæ¸…ç† (ä½¿ç”¨å»¶è¿Ÿ)
            setTimeout(() => {
                if (document.body.contains(printContainer)) {
                    document.body.removeChild(printContainer);
                }
            }, 500); // 0.5ç§’å»¶è¿Ÿ, ç¡®ä¿æ‰“å°å¯¹è¯æ¡†å·²å¤„ç†
        }

        /**
         * å‡†å¤‡æ¨¡å¼ä¸€çš„æ‰“å°æŠ¥å‘Š
         */
        function printReportMode1() {
            if (!lastMode1ResultText) {
                alert("æ²¡æœ‰å¯æ‰“å°çš„ç»“æœã€‚");
                return;
            }

            // 1. æ”¶é›†æ‰€æœ‰è¾“å…¥
            const inputs = {
                "æŠ¥å‘Šç±»å‹": "æ¨¡å¼ä¸€: æ€§èƒ½è¯„ä¼°",
                "åˆ¶å†·å‰‚": fluidSelectM1.value,
                "å‹ç¼©æœºè½¬é€Ÿ (RPM)": rpmInputM1.value,
                "ç†è®ºè¾“æ°”é‡æ¨¡å¼": document.querySelector('input[name="flow_mode"]:checked').value === 'rpm' ? 'æŒ‰è½¬é€Ÿä¸æ’é‡' : 'æŒ‰ä½“ç§¯æµé‡',
                "æ¯è½¬æ’é‡ (cmÂ³/rev)": flowModeRpmM1.checked ? displacementInputM1.value : 'N/A',
                "ç†è®ºä½“ç§¯æµé‡ (mÂ³/h)": flowModeVolM1.checked ? flowM3hInputM1.value : 'N/A',
                "å®¹é‡æ¨¡å¼": document.querySelector('input[name="capacity_mode"]:checked').value === 'heating' ? 'åˆ¶çƒ­é‡ (å†·å‡å™¨)' : 'åˆ¶å†·é‡',
                "è¾“å…¥å®¹é‡ (kW)": document.getElementById('capacity').value,
                "åŠŸç‡æ¨¡å¼": document.querySelector('input[name="power_mode"]:checked').value === 'input' ? 'è¾“å…¥åŠŸç‡ (ç”µæœº)' : 'è½´åŠŸç‡',
                "è¾“å…¥åŠŸç‡ (kW)": document.getElementById('power').value,
                "ç”µæœºæ•ˆç‡": document.querySelector('input[name="power_mode"]:checked').value === 'input' ? document.getElementById('motor_eff').value : 'N/A',
                "è’¸å‘æ¸©åº¦ (Â°C)": document.getElementById('temp_evap').value,
                "å†·å‡æ¸©åº¦ (Â°C)": document.getElementById('temp_cond').value,
                "æœ‰æ•ˆè¿‡çƒ­åº¦ (K)": document.getElementById('superheat').value,
                "è¿‡å†·åº¦ (K)": document.getElementById('subcooling').value,
            };

            // 2. ç”Ÿæˆæ‰“å°HTML
            let printHtml = `
                <h1>å‹ç¼©æœºæ€§èƒ½è®¡ç®—æŠ¥å‘Š</h1>
                <p>è®¡ç®—æ—¶é—´: ${new Date().toLocaleString('zh-CN')}</p>
                <h2>1. è¾“å…¥å‚æ•° (æ¨¡å¼ä¸€)</h2>
                <table class="print-table">
                    ${Object.entries(inputs).map(([key, value]) => `
                        <tr>
                            <th>${key}</th>
                            <td>${value}</td>
                        </tr>
                    `).join('')}
                </table>
                <h2>2. è®¡ç®—ç»“æœ (æ¨¡å¼ä¸€)</h2>
                <pre class="print-results">${lastMode1ResultText}</pre>
                <h3>--- æŠ¥å‘Šç»“æŸ (ç¼–è€…: è†ç‚è£) ---</h3>
            `;
            
            // 3. æ‰§è¡Œæ‰“å°
            callPrint(printHtml);
        }

        /**
         * å‡†å¤‡æ¨¡å¼äºŒçš„æ‰“å°æŠ¥å‘Š
         */
        function printReportMode2() {
            if (!lastMode2ResultText) {
                alert("æ²¡æœ‰å¯æ‰“å°çš„ç»“æœã€‚");
                return;
            }
            
            const inputs = {
                "æŠ¥å‘Šç±»å‹": "æ¨¡å¼äºŒ: æ€§èƒ½é¢„æµ‹",
                "åˆ¶å†·å‰‚": fluidSelectM2.value,
                "å‹ç¼©æœºè½¬é€Ÿ (RPM)": rpmInputM2.value,
                "ç†è®ºè¾“æ°”é‡æ¨¡å¼": document.querySelector('input[name="flow_mode_m2"]:checked').value === 'rpm' ? 'æŒ‰è½¬é€Ÿä¸æ’é‡' : 'æŒ‰ä½“ç§¯æµé‡',
                "æ¯è½¬æ’é‡ (cmÂ³/rev)": flowModeRpmM2.checked ? displacementInputM2.value : 'N/A',
                "ç†è®ºä½“ç§¯æµé‡ (mÂ³/h)": flowModeVolM2.checked ? flowM3hInputM2.value : 'N/A',
                "è’¸å‘æ¸©åº¦ (Â°C)": tempEvapM2.value,
                "å†·å‡æ¸©åº¦ (Â°C)": tempCondM2.value,
                "æœ‰æ•ˆè¿‡çƒ­åº¦ (K)": superheatM2.value,
                "è¿‡å†·åº¦ (K)": subcoolingM2.value,
                "æ•ˆç‡åŸºå‡†": document.querySelector('input[name="eff_mode_m2"]:checked').value === 'input' ? 'åŸºäºè¾“å…¥åŠŸç‡ (Î·_total)' : 'åŸºäºè½´åŠŸç‡ (Î·_s)',
                "è¾“å…¥ç­‰ç†µæ•ˆç‡": etaSInputM2.value,
                "å®¹ç§¯æ•ˆç‡ (Î·_v)": etaVInputM2.value,
                "ç”µæœºæ•ˆç‡": document.querySelector('input[name="eff_mode_m2"]:checked').value === 'input' ? motorEffInputM2.value : 'N/A',
            };

            let printHtml = `
                <h1>å‹ç¼©æœºæ€§èƒ½è®¡ç®—æŠ¥å‘Š</h1>
                <p>è®¡ç®—æ—¶é—´: ${new Date().toLocaleString('zh-CN')}</p>
                <h2>1. è¾“å…¥å‚æ•° (æ¨¡å¼äºŒ)</h2>
                <table class="print-table">
                    ${Object.entries(inputs).map(([key, value]) => `
                        <tr>
                            <th>${key}</th>
                            <td>${value}</td>
                        </tr>
                    `).join('')}
                </table>
                <h2>2. è®¡ç®—ç»“æœ (æ¨¡å¼äºŒ)</h2>
                <pre class="print-results">${lastMode2ResultText}</pre>
                <h3>--- æŠ¥å‘Šç»“æŸ (ç¼–è€…: è†ç‚è£) ---</h3>
            `;

            callPrint(printHtml);
        }

        // ç»‘å®šæ‰“å°æŒ‰é’®äº‹ä»¶
        printButtonM1.addEventListener('click', printReportMode1);
        printButtonM2.addEventListener('click', printReportMode2);


    </script>

</body>
</html>